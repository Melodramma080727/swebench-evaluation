name: SWE-bench Real Agents - SB-CLI Evaluation

on:
  workflow_dispatch:
    inputs:
      num_instances:
        description: 'Number of instances to test (1-10 recommended)'
        required: false
        default: '1'
      agent_repo:
        description: 'Agents repository URL'
        required: false
        default: 'https://github.com/Melodramma080727/Agents.git'
      subset:
        description: 'SWE-bench subset'
        required: false
        default: 'swe-bench_lite'
        type: choice
        options:
          - swe-bench_lite
          - swe-bench-m
          - swe-bench_verified
      split:
        description: 'Dataset split'
        required: false
        default: 'dev'
        type: choice
        options:
          - dev
          - test
      submit_to_sb_cli:
        description: 'Submit to SWE-bench CLI for evaluation'
        required: false
        default: true
        type: boolean

jobs:
  # Job 1: Generate predictions with Agents framework
  generate_predictions:
    runs-on: ubuntu-latest
    timeout-minutes: 240  # 4 hours: ~1 hour per instance + build time + buffer for 500 iterations
    
    outputs:
      predictions_file: ${{ steps.generate.outputs.predictions_file }}
      
    steps:
    - name: Maximize build space
      run: |
        sudo rm -rf /usr/share/dotnet
        sudo rm -rf /opt/ghc
        sudo rm -rf /usr/local/share/boost
        df -h
        
    - name: Checkout this repository
      uses: actions/checkout@v4
      
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
        
    - name: Install dependencies
      run: |
        pip install datasets sb-cli

    - name: Generate predictions with Agents framework
      id: generate
      run: |
        # Set environment variables for the Python script
        export NUM_INSTANCES="${{ github.event.inputs.num_instances }}"
        export AGENTS_REPO="${{ github.event.inputs.agent_repo }}"
        export MODEL_NAME="claude-sonnet-4-20250514"
        
        # Run the prediction generation script
        python3 generate_predictions.py | tee /tmp/generate.log
        
        # Extract predictions file from output
        PREDICTIONS_FILE=$(grep "predictions_file=" /tmp/generate.log | tail -1 | cut -d'=' -f2)
        echo "predictions_file=$PREDICTIONS_FILE" >> $GITHUB_OUTPUT
        
      env:
        ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}

  # Job 2: Convert format and submit to SB-CLI
  submit_to_sb_cli:
    runs-on: ubuntu-latest
    timeout-minutes: 30  # SB-CLI submission should be quick
    needs: generate_predictions
    if: ${{ github.event.inputs.submit_to_sb_cli == 'true' }}
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
        
    - name: Install SB-CLI
      run: |
        pip install sb-cli
        
    - name: Convert format and submit to SB-CLI
      env:
        PREDICTIONS_FILE: ${{ needs.generate_predictions.outputs.predictions_file }}
        SUBSET: ${{ github.event.inputs.subset }}
        SPLIT: ${{ github.event.inputs.split }}
        SWEBENCH_API_KEY: ${{ secrets.SWEBENCH_API_KEY }}
      run: |
        # Verify API key is available
        if [ -z "$SWEBENCH_API_KEY" ]; then
          echo "‚ùå SWEBENCH_API_KEY secret not set"
          echo "Please generate an API key and add it to GitHub Secrets:"
          echo "1. Run: sb-cli gen-api-key your-email@example.com"
          echo "2. Verify: sb-cli verify-api-key"
          echo "3. Add to GitHub Secrets as SWEBENCH_API_KEY"
          exit 1
        fi
        
        echo "‚úÖ SWE-bench API key found"
        
        # Convert format
        echo "üîÑ Converting predictions format..."
        python3 convert_to_sb_cli.py "$PREDICTIONS_FILE" --output /tmp/sb_cli_predictions.json
        
        # Submit to SB-CLI
        echo "üöÄ Submitting to SWE-bench CLI..."
        sb-cli submit "$SUBSET" "$SPLIT" \
          --predictions_path /tmp/sb_cli_predictions.json \
          --run_id "real_agents_$(date +%Y%m%d_%H%M%S)"